(function(){"use strict";var t,A,l;function e(t,e){this.parser=t,this.idGenerator=new hatemile.util.IDGenerator("association")}(A=this).hatemile||(this.hatemile={}),(t=this.hatemile).implementation||(t.implementation={}),this.hatemile.implementation.AccessibleAssociationImplementation=(l="data-ignoreaccessibilityfix",e.prototype._getModelTable=function(t){for(var e,i=[],r=this.parser.find(t).findChildren("tr").listResults(),l=0,s=r.length;l<s;l++)e=r[l],i.push(this._getModelRow(this.parser.find(e).findChildren("th,td").listResults()));return this._getValidModelTable(i)},e.prototype._getValidModelTable=function(t){var e,i,r,l,s,a,n,o,h,d,u,f,g,p,c=[],b=t.length;if(0<b)for(g=l=0,u=b-1;0<=u?l<=u:u<=l;g=0<=u?++l:--l)if(d=t[g],void 0===c[g]&&(c[g]=[]),0<(a=d.length))for(i=s=r=0,f=a-1;0<=f?s<=f:f<=s;i=0<=f?++s:--s){for(e=d[i],n=i+r,o=c[g];void 0!==o[n];)n=i+(r+=1);if((o[n]=e).hasAttribute("rowspan"))for(p=parseInt(e.getAttribute("rowspan")),h=g;1<p;)--p,void 0===c[h+=1]&&(c[h]=[]),c[h][n]=e}return c},e.prototype._getModelRow=function(t){var e,i,r,l,s,a=[],n=t.length;if(0<n)for(a=a.concat(t),r=l=e=0,s=n-1;0<=s?l<=s:s<=l;r=0<=s?++l:--l)if(t[r].hasAttribute("colspan"))for(i=parseInt(t[r].getAttribute("colspan"));1<i;)--i,e+=1,a.splice(r+e,0,t[r]);return a},e.prototype._validateHeader=function(t){var e,i,r,l;if(0===t.length)return!1;for(r=-1,e=0,i=t.length;e<i;e++){if(0===(l=t[e]).length)return!1;if(-1===r)r=l.length;else if(l.length!==r)return!1}return!0},e.prototype._getCellsHeadersIds=function(t,e){for(var i,r=[],l=0,s=t.length;l<s;l++)"TH"===(i=t[l][e]).getTagName()&&"col"===i.getAttribute("scope")&&r.push(i.getAttribute("id"));return r},e.prototype._associateDataCellsWithHeaderCellsOfRow=function(t){for(var e,i,r,l,s,a,n,o,h,d,u,f=this._getModelTable(t),g=0,p=f.length;g<p;g++){for(l=[],s=0,n=(u=f[g]).length;s<n;s++)"TH"===(e=u[s]).getTagName()&&(this.idGenerator.generateId(e),l.push(e.getAttribute("id")),e.setAttribute("scope","row"));if(0<l.length)for(a=0,o=u.length;a<o;a++)if("TD"===(e=u[a]).getTagName()){for(r=e.getAttribute("headers"),d=0,h=l.length;d<h;d++)i=l[d],r=A.hatemile.util.CommonFunctions.increaseInList(r,i);null!==r&&e.setAttribute("headers",r)}}},e.prototype._prepareHeaderCells=function(t){for(var e,i=this.parser.find(t).findChildren("tr").findChildren("th").listResults(),r=0,l=i.length;r<l;r++)e=i[r],this.idGenerator.generateId(e),e.hasAttribute("scope")||e.setAttribute("scope","col")},e.prototype.associateDataCellsWithHeaderCells=function(t){var e,i,r,l,s,a,n,o,h,d,u,f,g,p,c,b=this.parser.find(t).findChildren("thead").firstResult(),m=this.parser.find(t).findChildren("tbody").firstResult(),t=this.parser.find(t).findChildren("tfoot").firstResult();if(null!==b&&(this._prepareHeaderCells(b),r=this._getModelTable(b),null!==m&&this._validateHeader(r)))for(p=r[0].length,i=this._getModelTable(m),null!==t&&(i=i.concat(this._getModelTable(t))),o=0,u=i.length;o<u;o++)if((c=i[o]).length===p)for(h=n=0,f=c.length;h<f;h++){for(e=c[h],a=this._getCellsHeadersIds(r,n),l=e.getAttribute("headers"),d=0,g=a.length;d<g;d++)s=a[d],l=A.hatemile.util.CommonFunctions.increaseInList(l,s);null!==l&&e.setAttribute("headers",l),n+=1}null!==m&&this._associateDataCellsWithHeaderCellsOfRow(m),null!==t&&this._associateDataCellsWithHeaderCellsOfRow(t)},e.prototype.associateAllDataCellsWithHeaderCells=function(){for(var t,e=this.parser.find("table").listResults(),i=0,r=e.length;i<r;i++)t=e[i],A.hatemile.util.CommonFunctions.isValidElement(t)&&null===this.parser.find(t).findDescendants("thead["+l+"],tbody["+l+"],tfoot["+l+"],tr["+l+"],th["+l+"],td["+l+"]").firstResult()&&this.associateDataCellsWithHeaderCells(t)},e.prototype.associateLabelWithField=function(t){var e;"LABEL"===t.getTagName()&&(t.hasAttribute("for")?e=this.parser.find("#"+t.getAttribute("for")).firstResult():null!==(e=this.parser.find(t).findDescendants("input,select,textarea").firstResult())&&(this.idGenerator.generateId(e),t.setAttribute("for",e.getAttribute("id"))),null===e||e.hasAttribute(l)||(e.hasAttribute("aria-label")||e.setAttribute("aria-label",t.getTextContent().replace(new RegExp("[ \n\t\r]+","g")," ")),this.idGenerator.generateId(t),e.setAttribute("aria-labelledby",A.hatemile.util.CommonFunctions.increaseInList(e.getAttribute("aria-labelledby"),t.getAttribute("id")))))},e.prototype.associateAllLabelsWithFields=function(){for(var t,e=this.parser.find("label").listResults(),i=0,r=e.length;i<r;i++)t=e[i],A.hatemile.util.CommonFunctions.isValidElement(t)&&this.associateLabelWithField(t)},e)}).call(this);